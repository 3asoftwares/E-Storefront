# Deploy Frontend Apps to Vercel
# Triggers on: CI workflow completion (success) on main branch, manual dispatch
# Required secrets:
#   - VERCEL_TOKEN: Vercel API token
#   - VERCEL_ORG_ID: Vercel organization/team ID
#   - VERCEL_PROJECT_ID_ADMIN: Project ID for admin-app
#   - VERCEL_PROJECT_ID_SELLER: Project ID for seller-app
#   - VERCEL_PROJECT_ID_SHELL: Project ID for shell-app

name: Deploy to Vercel

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      app:
        description: 'App to deploy'
        required: true
        type: choice
        options:
          - admin-app
          - seller-app
          - shell-app
          - all
      force_deploy:
        description: 'Force deployment (ignore checks)'
        required: false
        type: boolean
        default: false

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  NODE_VERSION: '20'

jobs:
  # ===========================================
  # CHECK IF CI PASSED (for workflow_run trigger)
  # ===========================================
  check-ci:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Check CI status
        id: check
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Manual trigger, proceeding..."
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
            echo "CI passed, proceeding with deployment..."
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "CI did not pass (conclusion: ${{ github.event.workflow_run.conclusion }}), skipping deployment..."
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  # ===========================================
  # DETECT CHANGES (for push events)
  # ===========================================
  detect-changes:
    needs: check-ci
    if: needs.check-ci.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    outputs:
      admin-app: ${{ steps.changes.outputs.admin-app }}
      seller-app: ${{ steps.changes.outputs.seller-app }}
      shell-app: ${{ steps.changes.outputs.shell-app }}
      packages: ${{ steps.changes.outputs.packages }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            admin-app:
              - 'apps/admin-app/**'
            seller-app:
              - 'apps/seller-app/**'
            shell-app:
              - 'apps/shell-app/**'
            packages:
              - 'packages/**'

  # ===========================================
  # DEPLOY ADMIN APP
  # ===========================================
  deploy-admin:
    needs: [check-ci, detect-changes]
    if: |
      needs.check-ci.outputs.should_deploy == 'true' &&
      ((github.event_name == 'workflow_run' && (needs.detect-changes.outputs.admin-app == 'true' || needs.detect-changes.outputs.packages == 'true')) ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.app == 'admin-app' || github.event.inputs.app == 'all')))
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v4

      - name: Validate Vercel secrets
        run: |
          if [ -z "${{ secrets.VERCEL_ORG_ID }}" ]; then
            echo "::error::VERCEL_ORG_ID secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.VERCEL_PROJECT_ID_ADMIN }}" ]; then
            echo "::error::VERCEL_PROJECT_ID_ADMIN secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "::error::VERCEL_TOKEN secret is not set"
            exit 1
          fi
          echo "âœ… All required Vercel secrets are configured"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build packages
        run: |
          yarn build:types
          yarn build:utils
          yarn build:storybook

      - name: Build Admin App
        run: yarn build:admin

      - name: Deploy Admin App to Vercel
        id: deploy
        shell: bash
        run: |
          cd apps/admin-app
          
          # Sync environment variables from .env.production to Vercel
          echo "ðŸ“¦ Syncing environment variables to Vercel..."
          if [ -f ".env.production" ]; then
            while IFS= read -r line || [[ -n "$line" ]]; do
              # Skip comments and empty lines
              if [[ ! "$line" =~ ^# ]] && [[ -n "$line" ]] && [[ "$line" == *"="* ]]; then
                key=$(echo "$line" | cut -d '=' -f 1)
                value=$(echo "$line" | cut -d '=' -f 2-)
                echo "Setting $key..."
                vercel env rm "$key" production --yes --token=${{ secrets.VERCEL_TOKEN }} 2>/dev/null || true
                echo "$value" | vercel env add "$key" production --token=${{ secrets.VERCEL_TOKEN }}
              fi
            done < .env.production
          fi
          
          vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
          DEPLOY_URL=$(vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          echo "### ðŸš€ Admin App Deployed" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** $DEPLOY_URL" >> $GITHUB_STEP_SUMMARY
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_ADMIN }}

  # ===========================================
  # DEPLOY SELLER APP
  # ===========================================
  deploy-seller:
    needs: [check-ci, detect-changes]
    if: |
      needs.check-ci.outputs.should_deploy == 'true' &&
      ((github.event_name == 'workflow_run' && (needs.detect-changes.outputs.seller-app == 'true' || needs.detect-changes.outputs.packages == 'true')) ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.app == 'seller-app' || github.event.inputs.app == 'all')))
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Validate Vercel secrets
        run: |
          if [ -z "${{ secrets.VERCEL_ORG_ID }}" ]; then
            echo "::error::VERCEL_ORG_ID secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.VERCEL_PROJECT_ID_SELLER }}" ]; then
            echo "::error::VERCEL_PROJECT_ID_SELLER secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "::error::VERCEL_TOKEN secret is not set"
            exit 1
          fi
          echo "âœ… All required Vercel secrets are configured"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build packages
        run: |
          yarn build:types
          yarn build:utils
          yarn build:storybook

      - name: Build Seller App
        run: yarn build:seller

      - name: Deploy Seller App to Vercel
        id: deploy
        shell: bash
        run: |
          cd apps/seller-app
          
          # Sync environment variables from .env.production to Vercel
          echo "ðŸ“¦ Syncing environment variables to Vercel..."
          if [ -f ".env.production" ]; then
            while IFS= read -r line || [[ -n "$line" ]]; do
              # Skip comments and empty lines
              if [[ ! "$line" =~ ^# ]] && [[ -n "$line" ]] && [[ "$line" == *"="* ]]; then
                key=$(echo "$line" | cut -d '=' -f 1)
                value=$(echo "$line" | cut -d '=' -f 2-)
                echo "Setting $key..."
                vercel env rm "$key" production --yes --token=${{ secrets.VERCEL_TOKEN }} 2>/dev/null || true
                echo "$value" | vercel env add "$key" production --token=${{ secrets.VERCEL_TOKEN }}
              fi
            done < .env.production
          fi
          
          vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
          DEPLOY_URL=$(vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          echo "### ðŸš€ Seller App Deployed" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** $DEPLOY_URL" >> $GITHUB_STEP_SUMMARY
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_SELLER }}

  # ===========================================
  # DEPLOY SHELL APP
  # ===========================================
  deploy-shell:
    needs: [check-ci, detect-changes]
    if: |
      needs.check-ci.outputs.should_deploy == 'true' &&
      ((github.event_name == 'workflow_run' && (needs.detect-changes.outputs.shell-app == 'true' || needs.detect-changes.outputs.packages == 'true')) ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.app == 'shell-app' || github.event.inputs.app == 'all')))
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Validate Vercel secrets
        run: |
          if [ -z "${{ secrets.VERCEL_ORG_ID }}" ]; then
            echo "::error::VERCEL_ORG_ID secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.VERCEL_PROJECT_ID_SHELL }}" ]; then
            echo "::error::VERCEL_PROJECT_ID_SHELL secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "::error::VERCEL_TOKEN secret is not set"
            exit 1
          fi
          echo "âœ… All required Vercel secrets are configured"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build packages
        run: |
          yarn build:types
          yarn build:utils
          yarn build:storybook

      - name: Build Shell App
        run: yarn build:shell

      - name: Deploy Shell App to Vercel
        id: deploy
        shell: bash
        run: |
          cd apps/shell-app
          
          # Sync environment variables from .env.production to Vercel
          echo "ðŸ“¦ Syncing environment variables to Vercel..."
          if [ -f ".env.production" ]; then
            while IFS= read -r line || [[ -n "$line" ]]; do
              # Skip comments and empty lines
              if [[ ! "$line" =~ ^# ]] && [[ -n "$line" ]] && [[ "$line" == *"="* ]]; then
                key=$(echo "$line" | cut -d '=' -f 1)
                value=$(echo "$line" | cut -d '=' -f 2-)
                echo "Setting $key..."
                vercel env rm "$key" production --yes --token=${{ secrets.VERCEL_TOKEN }} 2>/dev/null || true
                echo "$value" | vercel env add "$key" production --token=${{ secrets.VERCEL_TOKEN }}
              fi
            done < .env.production
          fi
          
          vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
          DEPLOY_URL=$(vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          echo "### ðŸš€ Shell App Deployed" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** $DEPLOY_URL" >> $GITHUB_STEP_SUMMARY
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_SHELL }}

  # ===========================================
  # DEPLOYMENT SKIPPED
  # ===========================================
  skip-notification:
    needs: check-ci
    if: needs.check-ci.outputs.should_deploy == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Skipped
        run: |
          echo "## â­ï¸ Vercel Deployment Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "CI workflow did not pass or was not triggered on main branch." >> $GITHUB_STEP_SUMMARY
          echo "To force a deployment, run the workflow manually." >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # DEPLOYMENT SUMMARY
  # ===========================================
  summary:
    needs: [check-ci, deploy-admin, deploy-seller, deploy-shell]
    if: always() && needs.check-ci.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "## ðŸ“Š Vercel Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| App | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| admin-app | ${{ needs.deploy-admin.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| seller-app | ${{ needs.deploy-seller.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| shell-app | ${{ needs.deploy-shell.result }} |" >> $GITHUB_STEP_SUMMARY
