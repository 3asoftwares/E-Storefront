name: Publish Packages (NPM)

on:
  # Manual trigger only - requires CI to pass first
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to publish'
        required: true
        type: choice
        options:
          - all
          - types
          - utils
          - ui
      version_bump:
        description: 'Version bump type'
        required: true
        type: choice
        default: 'patch'
        options:
          - patch
          - minor
          - major
      dry_run:
        description: 'Dry run (test without publishing)'
        required: false
        type: boolean
        default: false

concurrency:
  group: publish-packages-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20'

jobs:
  # ===========================================
  # VERIFY CI PASSED
  # ===========================================
  verify-ci:
    name: Verify CI Passed
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check Latest CI Status
        run: |
          echo "Checking CI status for branch: ${{ github.ref_name }}"
          
          # Get the latest CI workflow run status
          CI_STATUS=$(gh run list --workflow=ci.yml --branch=${{ github.ref_name }} --limit=1 --json conclusion --jq '.[0].conclusion')
          
          echo "Latest CI status: $CI_STATUS"
          
          if [ "$CI_STATUS" != "success" ]; then
            echo "❌ CI Pipeline has not passed on this branch!"
            echo "Please ensure CI passes before publishing."
            echo "## ❌ CI Check Failed" >> $GITHUB_STEP_SUMMARY
            echo "Latest CI status: $CI_STATUS" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "✅ CI Pipeline passed!"
          echo "## ✅ CI Check Passed" >> $GITHUB_STEP_SUMMARY
        env:
          GH_TOKEN: ${{ github.token }}

  # ===========================================
  # SETUP
  # ===========================================
  setup:
    name: Setup
    runs-on: ubuntu-latest
    needs: verify-ci
    outputs:
      publish-types: ${{ steps.determine.outputs.types }}
      publish-utils: ${{ steps.determine.outputs.utils }}
      publish-ui: ${{ steps.determine.outputs.ui }}
    steps:
      - uses: actions/checkout@v4

      - name: Determine Packages to Publish
        id: determine
        run: |
          PACKAGE="${{ inputs.package }}"
          if [ "$PACKAGE" == "all" ]; then
            echo "types=true" >> $GITHUB_OUTPUT
            echo "utils=true" >> $GITHUB_OUTPUT
            echo "ui=true" >> $GITHUB_OUTPUT
          else
            echo "types=$([[ '$PACKAGE' == 'types' ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "utils=$([[ '$PACKAGE' == 'utils' ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "ui=$([[ '$PACKAGE' == 'ui' ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          fi
          
          echo "## Publish Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Package: $PACKAGE" >> $GITHUB_STEP_SUMMARY
          echo "- Version Bump: ${{ inputs.version_bump }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dry Run: ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          registry-url: 'https://registry.npmjs.org'

      - name: Install Dependencies
        run: yarn install --frozen-lockfile

      - name: Cache node_modules
        uses: actions/cache/save@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
          key: publish-node-modules-${{ github.sha }}

  # ===========================================
  # BUILD PACKAGES
  # ===========================================
  build:
    name: Build Packages
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
          key: publish-node-modules-${{ github.sha }}

      - name: Build Types
        if: needs.setup.outputs.publish-types == 'true'
        run: yarn build:types

      - name: Build Utils
        if: needs.setup.outputs.publish-utils == 'true'
        run: yarn build:utils

      - name: Build UI
        if: needs.setup.outputs.publish-ui == 'true'
        run: yarn build:ui

      - name: Cache build artifacts
        uses: actions/cache/save@v4
        with:
          path: |
            packages/types/dist
            packages/utils/dist
            packages/ui-library/dist
          key: publish-build-${{ github.sha }}

  # ===========================================
  # PUBLISH TYPES
  # ===========================================
  publish-types:
    name: Publish @3asoftwares/types
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: needs.setup.outputs.publish-types == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          registry-url: 'https://registry.npmjs.org'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
          key: publish-node-modules-${{ github.sha }}

      - name: Restore build artifacts
        uses: actions/cache/restore@v4
        with:
          path: |
            packages/types/dist
            packages/utils/dist
            packages/ui-library/dist
          key: publish-build-${{ github.sha }}

      - name: Bump Version
        working-directory: packages/types
        run: npm version ${{ inputs.version_bump }} --no-git-tag-version

      - name: Publish (Dry Run)
        if: inputs.dry_run == true
        working-directory: packages/types
        run: |
          echo "DRY RUN - Would publish @3asoftwares/types"
          npm pack --dry-run
          echo "### @3asoftwares/types - DRY RUN successful" >> $GITHUB_STEP_SUMMARY

      - name: Publish
        if: inputs.dry_run != true
        working-directory: packages/types
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Summary
        if: inputs.dry_run != true
        run: echo "### @3asoftwares/types published successfully" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # PUBLISH UTILS
  # ===========================================
  publish-utils:
    name: Publish @3asoftwares/utils
    runs-on: ubuntu-latest
    needs: [setup, build, publish-types]
    if: always() && needs.setup.outputs.publish-utils == 'true' && needs.build.result == 'success'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          registry-url: 'https://registry.npmjs.org'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
          key: publish-node-modules-${{ github.sha }}

      - name: Restore build artifacts
        uses: actions/cache/restore@v4
        with:
          path: |
            packages/types/dist
            packages/utils/dist
            packages/ui-library/dist
          key: publish-build-${{ github.sha }}

      - name: Bump Version
        working-directory: packages/utils
        run: npm version ${{ inputs.version_bump }} --no-git-tag-version

      - name: Publish (Dry Run)
        if: inputs.dry_run == true
        working-directory: packages/utils
        run: |
          echo "DRY RUN - Would publish @3asoftwares/utils"
          npm pack --dry-run
          echo "### @3asoftwares/utils - DRY RUN successful" >> $GITHUB_STEP_SUMMARY

      - name: Publish
        if: inputs.dry_run != true
        working-directory: packages/utils
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Summary
        if: inputs.dry_run != true
        run: echo "### @3asoftwares/utils published successfully" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # PUBLISH UI
  # ===========================================
  publish-ui:
    name: Publish @3asoftwares/ui
    runs-on: ubuntu-latest
    needs: [setup, build, publish-utils]
    if: always() && needs.setup.outputs.publish-ui == 'true' && needs.build.result == 'success'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          registry-url: 'https://registry.npmjs.org'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
          key: publish-node-modules-${{ github.sha }}

      - name: Restore build artifacts
        uses: actions/cache/restore@v4
        with:
          path: |
            packages/types/dist
            packages/utils/dist
            packages/ui-library/dist
          key: publish-build-${{ github.sha }}

      - name: Bump Version
        working-directory: packages/ui-library
        run: npm version ${{ inputs.version_bump }} --no-git-tag-version

      - name: Publish (Dry Run)
        if: inputs.dry_run == true
        working-directory: packages/ui-library
        run: |
          echo "DRY RUN - Would publish @3asoftwares/ui"
          npm pack --dry-run
          echo "### @3asoftwares/ui - DRY RUN successful" >> $GITHUB_STEP_SUMMARY

      - name: Publish
        if: inputs.dry_run != true
        working-directory: packages/ui-library
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Summary
        if: inputs.dry_run != true
        run: echo "### @3asoftwares/ui published successfully" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # SUMMARY
  # ===========================================
  summary:
    name: Publish Summary
    runs-on: ubuntu-latest
    needs: [setup, build, publish-types, publish-utils, publish-ui]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## NPM Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| @3asoftwares/types | ${{ needs.publish-types.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| @3asoftwares/utils | ${{ needs.publish-utils.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| @3asoftwares/ui | ${{ needs.publish-ui.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Check for Failures
        run: |
          TYPES="${{ needs.publish-types.result }}"
          UTILS="${{ needs.publish-utils.result }}"
          UI="${{ needs.publish-ui.result }}"
          
          if [ "$TYPES" == "failure" ] || [ "$UTILS" == "failure" ] || [ "$UI" == "failure" ]; then
            echo "Some packages failed to publish" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "All requested packages published successfully" >> $GITHUB_STEP_SUMMARY
