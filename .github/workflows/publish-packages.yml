# Publish Packages to npm
# Triggers on: push to main (with package changes), releases, manual dispatch
# Required secrets:
#   - NPM_TOKEN: npm access token with publish permissions
#
# To get NPM_TOKEN:
#   1. Go to https://www.npmjs.com/settings/YOUR_USERNAME/tokens
#   2. Generate New Token > Classic Token > Automation
#   3. Add it to GitHub Secrets as NPM_TOKEN
#
# Version bumping:
#   - On push to main: Publishes with current version (skips if already published)
#   - On release: Publishes with release tag version
#   - Manual dispatch: Can specify version bump type

name: Publish Packages to npm

on:
  push:
    branches:
      - main
    paths:
      - 'packages/types/**'
      - 'packages/utils/**'
      - 'packages/ui-library/**'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to publish'
        required: true
        default: 'all'
        type: choice
        options:
          - types
          - utils
          - ui-library
          - all
      version_bump:
        description: 'Version bump type (only for manual dispatch)'
        required: false
        type: choice
        options:
          - none
          - patch
          - minor
          - major
        default: 'none'

env:
  NODE_VERSION: '20'

jobs:
  # ===========================================
  # VALIDATE SECRETS
  # ===========================================
  validate-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Validate npm token
        run: |
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "::error::NPM_TOKEN secret is not set"
            echo "Please add NPM_TOKEN to your GitHub repository secrets."
            echo "Get your token from: https://www.npmjs.com/settings/YOUR_USERNAME/tokens"
            exit 1
          fi
          echo "âœ… NPM_TOKEN is configured"

  # ===========================================
  # PUBLISH @3asoftwares/types
  # ===========================================
  publish-types:
    needs: validate-secrets
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event_name == 'release' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.package == 'types' || github.event.inputs.package == 'all'))
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies from root
        run: |
          rm -rf node_modules
          yarn install --frozen-lockfile || yarn install

      - name: Build types package
        run: yarn build:types

      - name: Bump version (if specified)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.version_bump != 'none'
        working-directory: packages/types
        run: |
          npm version ${{ github.event.inputs.version_bump }} --no-git-tag-version
          echo "VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_ENV

      - name: Check if version exists
        id: check-version
        working-directory: packages/types
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          
          if npm view "$PACKAGE_NAME@$PACKAGE_VERSION" version 2>/dev/null; then
            echo "Version $PACKAGE_VERSION already exists on npm"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Version $PACKAGE_VERSION is new"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to npm
        if: steps.check-version.outputs.exists != 'true'
        working-directory: packages/types
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish Summary
        run: |
          if [ "${{ steps.check-version.outputs.exists }}" == "true" ]; then
            echo "### â­ï¸ Types Package Skipped" >> $GITHUB_STEP_SUMMARY
            echo "Version already exists on npm" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ“¦ Types Package Published" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================
  # PUBLISH @3asoftwares/utils
  # ===========================================
  publish-utils:
    needs: [validate-secrets, publish-types]
    runs-on: ubuntu-latest
    if: |
      always() && needs.validate-secrets.result == 'success' &&
      (github.event_name == 'push' ||
      github.event_name == 'release' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.package == 'utils' || github.event.inputs.package == 'all')))
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies from root
        run: |
          rm -rf node_modules
          yarn install --frozen-lockfile || yarn install

      - name: Build utils package
        run: yarn build:types && yarn build:utils

      - name: Bump version (if specified)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.version_bump != 'none'
        working-directory: packages/utils
        run: |
          npm version ${{ github.event.inputs.version_bump }} --no-git-tag-version
          echo "VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_ENV

      - name: Check if version exists
        id: check-version
        working-directory: packages/utils
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          
          if npm view "$PACKAGE_NAME@$PACKAGE_VERSION" version 2>/dev/null; then
            echo "Version $PACKAGE_VERSION already exists on npm"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Version $PACKAGE_VERSION is new"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to npm
        if: steps.check-version.outputs.exists != 'true'
        working-directory: packages/utils
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish Summary
        run: |
          if [ "${{ steps.check-version.outputs.exists }}" == "true" ]; then
            echo "### â­ï¸ Utils Package Skipped" >> $GITHUB_STEP_SUMMARY
            echo "Version already exists on npm" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ“¦ Utils Package Published" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================
  # PUBLISH @3asoftwares/ui-library
  # ===========================================
  publish-ui-library:
    needs: validate-secrets
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event_name == 'release' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.package == 'ui-library' || github.event.inputs.package == 'all'))
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies from root
        run: |
          rm -rf node_modules
          yarn install --frozen-lockfile || yarn install

      - name: Build ui-library package
        run: |
          yarn build:types
          yarn build:utils
          yarn build:storybook

      - name: Bump version (if specified)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.version_bump != 'none'
        working-directory: packages/ui-library
        run: |
          npm version ${{ github.event.inputs.version_bump }} --no-git-tag-version
          echo "VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_ENV

      - name: Check if version exists
        id: check-version
        working-directory: packages/ui-library
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          
          if npm view "$PACKAGE_NAME@$PACKAGE_VERSION" version 2>/dev/null; then
            echo "Version $PACKAGE_VERSION already exists on npm"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Version $PACKAGE_VERSION is new"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to npm
        if: steps.check-version.outputs.exists != 'true'
        working-directory: packages/ui-library
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish Summary
        run: |
          if [ "${{ steps.check-version.outputs.exists }}" == "true" ]; then
            echo "### â­ï¸ UI Library Package Skipped" >> $GITHUB_STEP_SUMMARY
            echo "Version already exists on npm" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ“¦ UI Library Package Published" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================
  # PUBLISH SUMMARY
  # ===========================================
  summary:
    needs: [publish-types, publish-utils, publish-ui-library]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Publish Summary
        run: |
          echo "## ðŸ“Š npm Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| @3asoftwares/types | ${{ needs.publish-types.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| @3asoftwares/utils | ${{ needs.publish-utils.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| @3asoftwares/ui-library | ${{ needs.publish-ui-library.result }} |" >> $GITHUB_STEP_SUMMARY
