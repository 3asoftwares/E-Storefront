name: Publish Packages (NPM)

on:
  # Auto-trigger after CI success on main branch
  workflow_run:
    workflows: ['CI Pipeline']
    types: [completed]
    branches: [main]
  # Manual trigger option
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to publish (overrides change detection)'
        required: false
        type: choice
        options:
          - auto
          - all
          - types
          - utils
          - ui
        default: 'auto'
      version_bump:
        description: 'Version bump type'
        required: true
        type: choice
        default: 'patch'
        options:
          - patch
          - minor
          - major
      dry_run:
        description: 'Dry run (test without publishing)'
        required: false
        type: boolean
        default: false

concurrency:
  group: publish-packages-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  # Default version bump for auto-trigger (workflow_run)
  DEFAULT_VERSION_BUMP: 'patch'

jobs:
  # ===========================================
  # VERIFY CI PASSED
  # ===========================================
  verify-ci:
    name: Verify CI Passed
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    outputs:
      proceed: ${{ steps.check.outputs.proceed }}
    steps:
      - name: CI Verification
        id: check
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "## Manual Trigger" >> $GITHUB_STEP_SUMMARY
            echo "proceed=true" >> $GITHUB_OUTPUT
          else
            echo "## CI Pipeline Passed" >> $GITHUB_STEP_SUMMARY
            echo "proceed=true" >> $GITHUB_OUTPUT
          fi
          echo "Proceeding with package publish check..." >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # DETECT CHANGES
  # ===========================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    needs: verify-ci
    if: needs.verify-ci.outputs.proceed == 'true'
    outputs:
      types-changed: ${{ steps.result.outputs.types }}
      utils-changed: ${{ steps.result.outputs.utils }}
      ui-changed: ${{ steps.result.outputs.ui }}
      any-changed: ${{ steps.result.outputs.any }}
      version-bump: ${{ steps.config.outputs.version-bump }}
      dry-run: ${{ steps.config.outputs.dry-run }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}
          fetch-depth: 2

      - name: Detect File Changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            types:
              - 'packages/types/src/**'
              - 'packages/types/package.json'
            utils:
              - 'packages/utils/src/**'
              - 'packages/utils/package.json'
            ui:
              - 'packages/ui-library/src/**'
              - 'packages/ui-library/package.json'

      - name: Set Configuration
        id: config
        run: |
          # Version bump
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version-bump=${{ inputs.version_bump }}" >> $GITHUB_OUTPUT
            echo "dry-run=${{ inputs.dry_run }}" >> $GITHUB_OUTPUT
          else
            echo "version-bump=${{ env.DEFAULT_VERSION_BUMP }}" >> $GITHUB_OUTPUT
            echo "dry-run=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine Packages to Publish
        id: result
        run: |
          PACKAGE="${{ inputs.package || 'auto' }}"
          
          if [ "$PACKAGE" == "all" ]; then
            echo "Publishing ALL packages (manual override)"
            echo "types=true" >> $GITHUB_OUTPUT
            echo "utils=true" >> $GITHUB_OUTPUT
            echo "ui=true" >> $GITHUB_OUTPUT
            echo "any=true" >> $GITHUB_OUTPUT
          elif [ "$PACKAGE" == "types" ]; then
            echo "Publishing TYPES only (manual override)"
            echo "types=true" >> $GITHUB_OUTPUT
            echo "utils=false" >> $GITHUB_OUTPUT
            echo "ui=false" >> $GITHUB_OUTPUT
            echo "any=true" >> $GITHUB_OUTPUT
          elif [ "$PACKAGE" == "utils" ]; then
            echo "Publishing UTILS only (manual override)"
            echo "types=false" >> $GITHUB_OUTPUT
            echo "utils=true" >> $GITHUB_OUTPUT
            echo "ui=false" >> $GITHUB_OUTPUT
            echo "any=true" >> $GITHUB_OUTPUT
          elif [ "$PACKAGE" == "ui" ]; then
            echo "Publishing UI only (manual override)"
            echo "types=false" >> $GITHUB_OUTPUT
            echo "utils=false" >> $GITHUB_OUTPUT
            echo "ui=true" >> $GITHUB_OUTPUT
            echo "any=true" >> $GITHUB_OUTPUT
          else
            # Auto-detect based on changes
            echo "Using change detection..."
            echo "types=${{ steps.filter.outputs.types }}" >> $GITHUB_OUTPUT
            echo "utils=${{ steps.filter.outputs.utils }}" >> $GITHUB_OUTPUT
            echo "ui=${{ steps.filter.outputs.ui }}" >> $GITHUB_OUTPUT
            
            if [ "${{ steps.filter.outputs.types }}" == "true" ] || [ "${{ steps.filter.outputs.utils }}" == "true" ] || [ "${{ steps.filter.outputs.ui }}" == "true" ]; then
              echo "any=true" >> $GITHUB_OUTPUT
            else
              echo "any=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Show Detection Results
        run: |
          echo "## Package Change Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Changed | Will Publish |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|--------------|" >> $GITHUB_STEP_SUMMARY
          echo "| @3asoftwares/types | ${{ steps.filter.outputs.types }} | ${{ steps.result.outputs.types }} |" >> $GITHUB_STEP_SUMMARY
          echo "| @3asoftwares/utils | ${{ steps.filter.outputs.utils }} | ${{ steps.result.outputs.utils }} |" >> $GITHUB_STEP_SUMMARY
          echo "| @3asoftwares/ui | ${{ steps.filter.outputs.ui }} | ${{ steps.result.outputs.ui }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version Bump:** ${{ steps.config.outputs.version-bump }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ steps.config.outputs.dry-run }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # SETUP
  # ===========================================
  setup:
    name: Setup
    runs-on: ubuntu-latest
    needs: detect-changes
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          registry-url: 'https://registry.npmjs.org'

      - name: Install Dependencies
        run: yarn install --frozen-lockfile

      - name: Cache node_modules
        uses: actions/cache/save@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
          key: publish-node-modules-${{ github.sha }}

  # ===========================================
  # BUILD PACKAGES
  # ===========================================
  build:
    name: Build Packages
    runs-on: ubuntu-latest
    needs: [detect-changes, setup]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          registry-url: 'https://registry.npmjs.org'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
          key: publish-node-modules-${{ github.sha }}

      - name: Build Types
        run: yarn build:types

      - name: Build Utils
        run: yarn build:utils

      - name: Build UI
        run: yarn build:ui

      - name: Cache build artifacts
        uses: actions/cache/save@v4
        with:
          path: |
            packages/types/dist
            packages/utils/dist
            packages/ui-library/dist
          key: publish-build-${{ github.sha }}

  # ===========================================
  # PUBLISH TYPES
  # ===========================================
  publish-types:
    name: Publish @3asoftwares/types
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          registry-url: 'https://registry.npmjs.org'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
          key: publish-node-modules-${{ github.sha }}

      - name: Restore build artifacts
        uses: actions/cache/restore@v4
        with:
          path: |
            packages/types/dist
            packages/utils/dist
            packages/ui-library/dist
          key: publish-build-${{ github.sha }}

      - name: Bump Version
        working-directory: packages/types
        run: npm version ${{ needs.detect-changes.outputs.version-bump }} --no-git-tag-version

      - name: Check if version exists
        id: version-check
        working-directory: packages/types
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "package=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          
          # Check if version exists on npm
          if npm view "$PACKAGE_NAME@$NEW_VERSION" version 2>/dev/null; then
            echo "Version $NEW_VERSION already exists on npm"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Version $NEW_VERSION is available"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish (Dry Run)
        if: needs.detect-changes.outputs.dry-run == 'true'
        working-directory: packages/types
        run: |
          echo "DRY RUN - Would publish @3asoftwares/types"
          npm pack --dry-run
          echo "### @3asoftwares/types - DRY RUN successful" >> $GITHUB_STEP_SUMMARY

      - name: Publish
        if: needs.detect-changes.outputs.dry-run != 'true' && steps.version-check.outputs.exists != 'true'
        working-directory: packages/types
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Skip - Version Exists
        if: steps.version-check.outputs.exists == 'true'
        run: |
          echo "### @3asoftwares/types - Skipped (v${{ steps.version-check.outputs.version }} already published)" >> $GITHUB_STEP_SUMMARY

      - name: Summary
        if: needs.detect-changes.outputs.dry-run != 'true' && steps.version-check.outputs.exists != 'true'
        run: echo "### @3asoftwares/types v${{ steps.version-check.outputs.version }} published successfully" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # PUBLISH UTILS
  # ===========================================
  publish-utils:
    name: Publish @3asoftwares/utils
    runs-on: ubuntu-latest
    needs: [detect-changes, build, publish-types]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          registry-url: 'https://registry.npmjs.org'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
          key: publish-node-modules-${{ github.sha }}

      - name: Restore build artifacts
        uses: actions/cache/restore@v4
        with:
          path: |
            packages/types/dist
            packages/utils/dist
            packages/ui-library/dist
          key: publish-build-${{ github.sha }}

      - name: Bump Version
        working-directory: packages/utils
        run: npm version ${{ needs.detect-changes.outputs.version-bump }} --no-git-tag-version

      - name: Check if version exists
        id: version-check
        working-directory: packages/utils
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "package=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          
          # Check if version exists on npm
          if npm view "$PACKAGE_NAME@$NEW_VERSION" version 2>/dev/null; then
            echo "Version $NEW_VERSION already exists on npm"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Version $NEW_VERSION is available"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish (Dry Run)
        if: needs.detect-changes.outputs.dry-run == 'true'
        working-directory: packages/utils
        run: |
          echo "DRY RUN - Would publish @3asoftwares/utils"
          npm pack --dry-run
          echo "### @3asoftwares/utils - DRY RUN successful" >> $GITHUB_STEP_SUMMARY

      - name: Publish
        if: needs.detect-changes.outputs.dry-run != 'true' && steps.version-check.outputs.exists != 'true'
        working-directory: packages/utils
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Skip - Version Exists
        if: steps.version-check.outputs.exists == 'true'
        run: |
          echo "### @3asoftwares/utils - Skipped (v${{ steps.version-check.outputs.version }} already published)" >> $GITHUB_STEP_SUMMARY

      - name: Summary
        if: needs.detect-changes.outputs.dry-run != 'true' && steps.version-check.outputs.exists != 'true'
        run: echo "### @3asoftwares/utils v${{ steps.version-check.outputs.version }} published successfully" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # PUBLISH UI
  # ===========================================
  publish-ui:
    name: Publish @3asoftwares/ui
    runs-on: ubuntu-latest
    needs: [detect-changes, build, publish-utils]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          registry-url: 'https://registry.npmjs.org'

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
          key: publish-node-modules-${{ github.sha }}

      - name: Restore build artifacts
        uses: actions/cache/restore@v4
        with:
          path: |
            packages/types/dist
            packages/utils/dist
            packages/ui-library/dist
          key: publish-build-${{ github.sha }}

      - name: Bump Version
        working-directory: packages/ui-library
        run: npm version ${{ needs.detect-changes.outputs.version-bump }} --no-git-tag-version

      - name: Check if version exists
        id: version-check
        working-directory: packages/ui-library
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "package=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          
          # Check if version exists on npm
          if npm view "$PACKAGE_NAME@$NEW_VERSION" version 2>/dev/null; then
            echo "Version $NEW_VERSION already exists on npm"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Version $NEW_VERSION is available"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish (Dry Run)
        if: needs.detect-changes.outputs.dry-run == 'true'
        working-directory: packages/ui-library
        run: |
          echo "DRY RUN - Would publish @3asoftwares/ui"
          npm pack --dry-run
          echo "### @3asoftwares/ui - DRY RUN successful" >> $GITHUB_STEP_SUMMARY

      - name: Publish
        if: needs.detect-changes.outputs.dry-run != 'true' && steps.version-check.outputs.exists != 'true'
        working-directory: packages/ui-library
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Skip - Version Exists
        if: steps.version-check.outputs.exists == 'true'
        run: |
          echo "### @3asoftwares/ui - Skipped (v${{ steps.version-check.outputs.version }} already published)" >> $GITHUB_STEP_SUMMARY

      - name: Summary
        if: needs.detect-changes.outputs.dry-run != 'true' && steps.version-check.outputs.exists != 'true'
        run: echo "### @3asoftwares/ui v${{ steps.version-check.outputs.version }} published successfully" >> $GITHUB_STEP_SUMMARY

  # no-changes job removed - all packages publish now

  # ===========================================
  # SUMMARY
  # ===========================================
  summary:
    name: Publish Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, build, publish-types, publish-utils, publish-ui]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## NPM Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.detect-changes.outputs.any-changed }}" != "true" ]; then
            echo "No packages were changed - publish skipped." >> $GITHUB_STEP_SUMMARY
          else
            PUBLISHED=false
            
            echo "| Package | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ needs.publish-types.result }}" == "success" ]; then
              echo "| @3asoftwares/types | published |" >> $GITHUB_STEP_SUMMARY
              PUBLISHED=true
            elif [ "${{ needs.publish-types.result }}" == "failure" ]; then
              echo "| @3asoftwares/types | failed |" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "${{ needs.publish-utils.result }}" == "success" ]; then
              echo "| @3asoftwares/utils | published |" >> $GITHUB_STEP_SUMMARY
              PUBLISHED=true
            elif [ "${{ needs.publish-utils.result }}" == "failure" ]; then
              echo "| @3asoftwares/utils | failed |" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "${{ needs.publish-ui.result }}" == "success" ]; then
              echo "| @3asoftwares/ui | published |" >> $GITHUB_STEP_SUMMARY
              PUBLISHED=true
            elif [ "${{ needs.publish-ui.result }}" == "failure" ]; then
              echo "| @3asoftwares/ui | failed |" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "$PUBLISHED" != "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "No packages were published (no source changes detected)." >> $GITHUB_STEP_SUMMARY
            fi
          fi
