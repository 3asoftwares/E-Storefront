# Deploy Microservices to Railway
# Triggers on: CI workflow completion (success) on main branch, manual dispatch
# Required secrets:
#   - RAILWAY_TOKEN: Railway API token
#   - RAILWAY_PROJECT_ID: Railway project ID

name: Deploy to Railway

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy'
        required: true
        type: choice
        options:
          - auth-service
          - category-service
          - coupon-service
          - graphql-gateway
          - order-service
          - product-service
          - all
      force_deploy:
        description: 'Force deployment (ignore checks)'
        required: false
        type: boolean
        default: false

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  NODE_VERSION: '20'

jobs:
  # ===========================================
  # CHECK IF CI PASSED (for workflow_run trigger)
  # ===========================================
  check-ci:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Check CI status
        id: check
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Manual trigger, proceeding..."
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
            echo "CI passed, proceeding with deployment..."
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "CI did not pass (conclusion: ${{ github.event.workflow_run.conclusion }}), skipping deployment..."
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  # ===========================================
  # VALIDATE SECRETS
  # ===========================================
  validate-secrets:
    needs: check-ci
    if: needs.check-ci.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Validate Railway secrets
        run: |
          if [ -z "${{ secrets.RAILWAY_TOKEN }}" ]; then
            echo "::error::RAILWAY_TOKEN secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.RAILWAY_PROJECT_ID }}" ]; then
            echo "::error::RAILWAY_PROJECT_ID secret is not set"
            exit 1
          fi
          echo "âœ… All required Railway secrets are configured"

  # ===========================================
  # BUILD SHARED PACKAGES
  # ===========================================
  build-packages:
    needs: [check-ci, validate-secrets]
    if: needs.check-ci.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build shared packages
        run: |
          yarn build:types
          yarn build:utils

      - name: Cache built packages
        uses: actions/cache@v4
        with:
          path: |
            packages/types/dist
            packages/utils/dist
          key: packages-${{ github.sha }}

  # ===========================================
  # DEPLOY AUTH SERVICE
  # ===========================================
  deploy-auth:
    needs: [check-ci, build-packages]
    if: |
      needs.check-ci.outputs.should_deploy == 'true' &&
      (github.event_name == 'workflow_run' || github.event_name == 'workflow_dispatch' && (github.event.inputs.service == 'auth-service' || github.event.inputs.service == 'all'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Restore built packages
        uses: actions/cache@v4
        with:
          path: |
            packages/types/dist
            packages/utils/dist
          key: packages-${{ github.sha }}

      - name: Build packages (if cache miss)
        run: |
          if [ ! -d "packages/types/dist" ]; then
            yarn build:types
            yarn build:utils
          fi

      - name: Build service
        run: yarn build:auth

      - name: Deploy to Railway
        run: |
          cd services/auth-service
          railway link ${{ secrets.RAILWAY_PROJECT_ID }} --environment production
          
          # Sync environment variables from .env.production to Railway
          echo "ðŸ“¦ Syncing environment variables to Railway..."
          if [ -f ".env.production" ]; then
            while IFS= read -r line || [[ -n "$line" ]]; do
              # Skip comments and empty lines
              if [[ ! "$line" =~ ^# ]] && [[ -n "$line" ]] && [[ "$line" == *"="* ]]; then
                key=$(echo "$line" | cut -d '=' -f 1)
                value=$(echo "$line" | cut -d '=' -f 2-)
                echo "Setting $key..."
                railway variables set "$key=$value" --service auth-service 2>/dev/null || true
              fi
            done < .env.production
          fi
          
          railway up --service auth-service --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Deployment Summary
        run: |
          echo "### ðŸš€ Auth Service Deployed" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # DEPLOY CATEGORY SERVICE
  # ===========================================
  deploy-category:
    needs: [check-ci, build-packages]
    if: |
      needs.check-ci.outputs.should_deploy == 'true' &&
      (github.event_name == 'workflow_run' || github.event_name == 'workflow_dispatch' && (github.event.inputs.service == 'category-service' || github.event.inputs.service == 'all'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Restore built packages
        uses: actions/cache@v4
        with:
          path: |
            packages/types/dist
            packages/utils/dist
          key: packages-${{ github.sha }}

      - name: Build packages (if cache miss)
        run: |
          if [ ! -d "packages/types/dist" ]; then
            yarn build:types
            yarn build:utils
          fi

      - name: Build service
        run: yarn build:category

      - name: Deploy to Railway
        run: |
          cd services/category-service
          railway link ${{ secrets.RAILWAY_PROJECT_ID }} --environment production
          
          # Sync environment variables from .env.production to Railway
          echo "ðŸ“¦ Syncing environment variables to Railway..."
          if [ -f ".env.production" ]; then
            while IFS= read -r line || [[ -n "$line" ]]; do
              if [[ ! "$line" =~ ^# ]] && [[ -n "$line" ]] && [[ "$line" == *"="* ]]; then
                key=$(echo "$line" | cut -d '=' -f 1)
                value=$(echo "$line" | cut -d '=' -f 2-)
                echo "Setting $key..."
                railway variables set "$key=$value" --service category-service 2>/dev/null || true
              fi
            done < .env.production
          fi
          
          railway up --service category-service --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Deployment Summary
        run: |
          echo "### ðŸš€ Category Service Deployed" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # DEPLOY COUPON SERVICE
  # ===========================================
  deploy-coupon:
    needs: [check-ci, build-packages]
    if: |
      needs.check-ci.outputs.should_deploy == 'true' &&
      (github.event_name == 'workflow_run' || github.event_name == 'workflow_dispatch' && (github.event.inputs.service == 'coupon-service' || github.event.inputs.service == 'all'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Restore built packages
        uses: actions/cache@v4
        with:
          path: |
            packages/types/dist
            packages/utils/dist
          key: packages-${{ github.sha }}

      - name: Build packages (if cache miss)
        run: |
          if [ ! -d "packages/types/dist" ]; then
            yarn build:types
            yarn build:utils
          fi

      - name: Build service
        run: yarn build:coupon

      - name: Deploy to Railway
        run: |
          cd services/coupon-service
          railway link ${{ secrets.RAILWAY_PROJECT_ID }} --environment production
          
          # Sync environment variables from .env.production to Railway
          echo "ðŸ“¦ Syncing environment variables to Railway..."
          if [ -f ".env.production" ]; then
            while IFS= read -r line || [[ -n "$line" ]]; do
              if [[ ! "$line" =~ ^# ]] && [[ -n "$line" ]] && [[ "$line" == *"="* ]]; then
                key=$(echo "$line" | cut -d '=' -f 1)
                value=$(echo "$line" | cut -d '=' -f 2-)
                echo "Setting $key..."
                railway variables set "$key=$value" --service coupon-service 2>/dev/null || true
              fi
            done < .env.production
          fi
          
          railway up --service coupon-service --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Deployment Summary
        run: |
          echo "### ðŸš€ Coupon Service Deployed" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # DEPLOY GRAPHQL GATEWAY
  # ===========================================
  deploy-gateway:
    needs: [check-ci, build-packages]
    if: |
      needs.check-ci.outputs.should_deploy == 'true' &&
      (github.event_name == 'workflow_run' || github.event_name == 'workflow_dispatch' && (github.event.inputs.service == 'graphql-gateway' || github.event.inputs.service == 'all'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Restore built packages
        uses: actions/cache@v4
        with:
          path: |
            packages/types/dist
            packages/utils/dist
          key: packages-${{ github.sha }}

      - name: Build packages (if cache miss)
        run: |
          if [ ! -d "packages/types/dist" ]; then
            yarn build:types
            yarn build:utils
          fi

      - name: Build service
        run: yarn build:gateway

      - name: Deploy to Railway
        run: |
          cd services/graphql-gateway
          railway link ${{ secrets.RAILWAY_PROJECT_ID }} --environment production
          
          # Sync environment variables from .env.production to Railway
          echo "ðŸ“¦ Syncing environment variables to Railway..."
          if [ -f ".env.production" ]; then
            while IFS= read -r line || [[ -n "$line" ]]; do
              if [[ ! "$line" =~ ^# ]] && [[ -n "$line" ]] && [[ "$line" == *"="* ]]; then
                key=$(echo "$line" | cut -d '=' -f 1)
                value=$(echo "$line" | cut -d '=' -f 2-)
                echo "Setting $key..."
                railway variables set "$key=$value" --service graphql-gateway 2>/dev/null || true
              fi
            done < .env.production
          fi
          
          railway up --service graphql-gateway --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Deployment Summary
        run: |
          echo "### ðŸš€ GraphQL Gateway Deployed" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # DEPLOY ORDER SERVICE
  # ===========================================
  deploy-order:
    needs: [check-ci, build-packages]
    if: |
      needs.check-ci.outputs.should_deploy == 'true' &&
      (github.event_name == 'workflow_run' || github.event_name == 'workflow_dispatch' && (github.event.inputs.service == 'order-service' || github.event.inputs.service == 'all'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Restore built packages
        uses: actions/cache@v4
        with:
          path: |
            packages/types/dist
            packages/utils/dist
          key: packages-${{ github.sha }}

      - name: Build packages (if cache miss)
        run: |
          if [ ! -d "packages/types/dist" ]; then
            yarn build:types
            yarn build:utils
          fi

      - name: Build service
        run: yarn build:order

      - name: Deploy to Railway
        run: |
          cd services/order-service
          railway link ${{ secrets.RAILWAY_PROJECT_ID }} --environment production
          
          # Sync environment variables from .env.production to Railway
          echo "ðŸ“¦ Syncing environment variables to Railway..."
          if [ -f ".env.production" ]; then
            while IFS= read -r line || [[ -n "$line" ]]; do
              if [[ ! "$line" =~ ^# ]] && [[ -n "$line" ]] && [[ "$line" == *"="* ]]; then
                key=$(echo "$line" | cut -d '=' -f 1)
                value=$(echo "$line" | cut -d '=' -f 2-)
                echo "Setting $key..."
                railway variables set "$key=$value" --service order-service 2>/dev/null || true
              fi
            done < .env.production
          fi
          
          railway up --service order-service --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Deployment Summary
        run: |
          echo "### ðŸš€ Order Service Deployed" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # DEPLOY PRODUCT SERVICE
  # ===========================================
  deploy-product:
    needs: [check-ci, build-packages]
    if: |
      needs.check-ci.outputs.should_deploy == 'true' &&
      (github.event_name == 'workflow_run' || github.event_name == 'workflow_dispatch' && (github.event.inputs.service == 'product-service' || github.event.inputs.service == 'all'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Restore built packages
        uses: actions/cache@v4
        with:
          path: |
            packages/types/dist
            packages/utils/dist
          key: packages-${{ github.sha }}

      - name: Build packages (if cache miss)
        run: |
          if [ ! -d "packages/types/dist" ]; then
            yarn build:types
            yarn build:utils
          fi

      - name: Build service
        run: yarn build:product

      - name: Deploy to Railway
        run: |
          cd services/product-service
          railway link ${{ secrets.RAILWAY_PROJECT_ID }} --environment production
          
          # Sync environment variables from .env.production to Railway
          echo "ðŸ“¦ Syncing environment variables to Railway..."
          if [ -f ".env.production" ]; then
            while IFS= read -r line || [[ -n "$line" ]]; do
              if [[ ! "$line" =~ ^# ]] && [[ -n "$line" ]] && [[ "$line" == *"="* ]]; then
                key=$(echo "$line" | cut -d '=' -f 1)
                value=$(echo "$line" | cut -d '=' -f 2-)
                echo "Setting $key..."
                railway variables set "$key=$value" --service product-service 2>/dev/null || true
              fi
            done < .env.production
          fi
          
          railway up --service product-service --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Deployment Summary
        run: |
          echo "### ðŸš€ Product Service Deployed" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # DEPLOYMENT SKIPPED
  # ===========================================
  skip-notification:
    needs: check-ci
    if: needs.check-ci.outputs.should_deploy == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Skipped
        run: |
          echo "## â­ï¸ Railway Deployment Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "CI workflow did not pass or was not triggered on main branch." >> $GITHUB_STEP_SUMMARY
          echo "To force a deployment, run the workflow manually." >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # DEPLOYMENT SUMMARY
  # ===========================================
  summary:
    needs: [check-ci, deploy-auth, deploy-category, deploy-coupon, deploy-gateway, deploy-order, deploy-product]
    if: always() && needs.check-ci.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "## ðŸ“Š Railway Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| auth-service | ${{ needs.deploy-auth.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| category-service | ${{ needs.deploy-category.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| coupon-service | ${{ needs.deploy-coupon.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| graphql-gateway | ${{ needs.deploy-gateway.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| order-service | ${{ needs.deploy-order.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| product-service | ${{ needs.deploy-product.result }} |" >> $GITHUB_STEP_SUMMARY
